{% extends 'base.html' %}
{% block title %}{{ project.name }} - 明細書エディタ{% endblock %}

{% block content %}
<style>
    /* 処理中モーダルのスタイル */
    .modal-backdrop { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.5); 
        z-index: 1050; 
        display: none; 
        justify-content: center; 
        align-items: center; 
    }
    .modal-content-custom { 
        background: white; 
        padding: 20px 40px; 
        border-radius: 8px; 
        text-align: center; 
        z-index: 1051; 
    }
    .actions-cell { width: 95px; text-align: center; }
    .color-cell { width: 90px; }
    .search-query-display { font-size: 0.8em; color: #666; }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">明細書エディタ: {{ project.name }}</h1>
    <a href="{{ url_for('home') }}" class="btn btn-secondary">プロジェクト一覧に戻る</a>
</div>

<div class="row g-4">
    <!-- 左側パネル -->
    <div class="col-lg-5">
        <div class="card sticky-top" style="top: 6rem;">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation"><button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-search-pane" type="button">テキスト探索</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" id="shape-tab" data-bs-toggle="tab" data-bs-target="#shape-search-pane" type="button">図形探索</button></li>
                </ul>
            </div>
            <div class="card-body tab-content" id="myTabContent">
                <!-- テキスト探索フォーム -->
                <div class="tab-pane fade show active" id="text-search-pane" role="tabpanel">
                    <form action="{{ url_for('add_item', project_id=project.id) }}" method="post" class="processing-form">
                        <input type="hidden" name="item_type" value="text_search">
                        <div class="mb-2"><label class="form-label">検索文字列</label><input type="text" name="search_query" class="form-control" required></div>
                        <div class="mb-2"><label class="form-label">品名</label><input type="text" name="hinmei" class="form-control" required></div>
                        <div class="mb-2"><label class="form-label">品質・寸法</label><input type="text" name="hinshitsu" class="form-control" required></div>
                        <div class="mb-2"><label class="form-label">単位</label><input type="text" name="tani" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">色番号 (1:赤, 2:黄...)</label><input type="number" name="color" class="form-control" value="1" min="1" required></div>
                        <button type="submit" class="btn btn-primary">検索してリストに追加</button>
                    </form>
                </div>
                <!-- 図形探索フォーム -->
                <div class="tab-pane fade" id="shape-search-pane" role="tabpanel">
                    <form action="{{ url_for('add_item', project_id=project.id) }}" method="post" class="processing-form">
                        <input type="hidden" name="item_type" value="shape_search">
                        <div class="mb-2"><label class="form-label">探索対象</label>
                            <select name="shape_target" class="form-select">
                                <option value="vehicle">車両灯器</option>
                                <option value="pedestrian">歩行者用灯器</option>
                            </select>
                        </div>
                        <div class="mb-2"><label class="form-label">品名</label><input type="text" name="hinmei" class="form-control" required></div>
                        <div class="mb-2"><label class="form-label">品質・寸法</label><input type="text" name="hinshitsu" class="form-control" required></div>
                        <div class="mb-2"><label class="form-label">単位</label><input type="text" name="tani" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">色番号 (1:赤, 2:黄...)</label><input type="number" name="color" class="form-control" value="1" min="1" required></div>
                        <button type="submit" class="btn btn-primary">探索してリストに追加</button>
                    </form>
                </div>
                <hr>
                <form action="{{ url_for('add_subtotal', project_id=project.id) }}" method="post" class="mt-3">
                    <button type="submit" class="btn btn-info">「計」の行を追加</button>
                </form>
            </div>
        </div>
    </div>
    <!-- 右側パネル -->
    <div class="col-lg-7">
        <div class="card">
            <div class="card-body">
                <form id="main-form" action="{{ url_for('update_all', project_id=project.id) }}" method="post">
                    <h5 class="card-title">ヘッダーと内訳リストの編集</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6"><label class="form-label">工事場所</label><input type="text" name="kouji_basho" class="form-control" value="{{ project.kouji_basho }}"></div>
                        <div class="col-md-4"><label class="form-label">合計金額</label><input type="text" name="gokei_kingaku" class="form-control" value="{{ project.gokei_kingaku }}"></div>
                        <div class="col-md-2"><label class="form-label">ページ数</label><input type="text" name="page_number" class="form-control" value="{{ project.page_number }}"></div>
                    </div>
                    <table class="table table-bordered align-middle">
                        <thead><tr><th>品名</th><th>品質・寸法</th><th>数量</th><th>単位</th><th class="color-cell">色</th><th class="actions-cell">操作</th></tr></thead>
                        <tbody>
                            {% for item in items %}
                            <tr>
                                <td>
                                    <input type="text" name="hinmei_{{ loop.index0 }}" class="form-control" value="{{ item.hinmei }}">
                                    {% if item.item_type != 'subtotal' %}
                                    <div class="search-query-display">({{ item.search_display_text }})</div>
                                    {% endif %}
                                </td>
                                <td>{% if item.item_type != 'subtotal' %}<input type="text" name="hinshitsu_{{ loop.index0 }}" class="form-control" value="{{ item.hinshitsu }}">{% endif %}</td>
                                <td class="text-center">{% if item.item_type != 'subtotal' %}{{ item.suryo }}{% endif %}</td>
                                <td>{% if item.item_type != 'subtotal' %}<input type="text" name="tani_{{ loop.index0 }}" class="form-control" value="{{ item.tani }}">{% endif %}</td>
                                <td>{% if item.item_type != 'subtotal' %}<input type="number" name="color_{{ loop.index0 }}" class="form-control" value="{{ item.color }}" min="1">{% endif %}</td>
                                <td class="actions-cell">
                                    <div class="btn-group">
                                        <button type="submit" formaction="{{ url_for('move_item', project_id=project.id, item_id=item.id, direction='up') }}" class="btn btn-secondary btn-sm" {% if loop.first %}disabled{% endif %}>↑</button>
                                        <button type="submit" formaction="{{ url_for('move_item', project_id=project.id, item_id=item.id, direction='down') }}" class="btn btn-secondary btn-sm" {% if loop.last %}disabled{% endif %}>↓</button>
                                        <button type="submit" formaction="{{ url_for('delete_item', project_id=project.id, item_id=item.id) }}" class="btn btn-danger btn-sm">×</button>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="6">まだ項目がありません。左のフォームから追加してください。</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <div class="mt-3 d-flex justify-content-between align-items-center flex-wrap">
                        <button type="submit" class="btn btn-success mb-2 processing-button">ヘッダーとリストの変更を保存</button>
                        <div class="btn-toolbar mb-2" role="toolbar">
                            <div class="btn-group me-2"><button type="submit" formaction="{{ url_for('generate', project_id=project.id) }}" name="report" value="1" class="btn btn-info" formtarget="_blank">印刷用レポート</button></div>
                            <div class="btn-group me-2"><button type="submit" formaction="{{ url_for('generate', project_id=project.id) }}" name="excel" value="1" class="btn btn-primary download-button">色変更Excel</button></div>
                            <div class="btn-group"><button type="submit" formaction="{{ url_for('generate_dxf', project_id=project.id) }}" class="btn btn-dark download-button">DXF再変換</button></div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="loading-modal" class="modal-backdrop">
    <div class="modal-content-custom">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        <p class="mt-2 mb-0">処理中です。しばらくお待ちください...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadingModal = document.getElementById('loading-modal');
    
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(event) {
            const submitter = event.submitter;
            if (submitter && (submitter.classList.contains('processing-button') || submitter.closest('.processing-form'))) {
                loadingModal.style.display = 'flex';
            }
        });
    });

    // ★★★★★★★★★★★★★★★ バグ修正: ダウンロードボタンの処理 ★★★★★★★★★★★★★★★
    // ダウンロードボタンはモーダルを表示せず、クリック後に通常のフォーム送信を行う
    // これにより、ファイルがダウンロードされた後も画面が固まるのを防ぐ
    // (JavaScript側での特別な処理は不要。ボタンから 'processing-button' クラスを削除したことで対応)
});
</script>
{% endblock %}
